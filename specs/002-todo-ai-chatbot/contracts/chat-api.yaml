openapi: 3.1.0
info:
  title: Todo AI Chatbot API
  description: |
    Phase 3 Chat API endpoints for AI-powered task management.
    All endpoints require JWT authentication via Bearer token.
  version: 1.0.0
  contact:
    name: Todo App Team

servers:
  - url: http://localhost:8000/api
    description: Local development
  - url: https://api.todoapp.example.com/api
    description: Production

security:
  - BearerAuth: []

tags:
  - name: Chat
    description: AI chatbot conversation endpoints

paths:
  /chat:
    post:
      tags:
        - Chat
      summary: Send message to AI chatbot
      description: |
        Send a natural language message to the AI assistant.
        The assistant can execute task operations (add, list, complete, delete, update)
        based on user intent.
      operationId: sendChatMessage
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              addTask:
                summary: Add a task
                value:
                  message: "Add a task to buy groceries"
              listTasks:
                summary: List tasks
                value:
                  message: "Show me my tasks"
              completeTask:
                summary: Complete a task
                value:
                  message: "Mark buy groceries as done"
              deleteTask:
                summary: Delete a task
                value:
                  message: "Delete the buy groceries task"
              updateTask:
                summary: Update a task
                value:
                  message: "Change buy groceries to buy organic groceries"
              generalQuery:
                summary: General question
                value:
                  message: "What can you help me with?"
      responses:
        '200':
          description: Successful response from AI
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                taskCreated:
                  summary: Task created successfully
                  value:
                    response: "I've added 'buy groceries' to your tasks."
                    tool_calls:
                      - tool: "add_task"
                        result: "success"
                        task_id: "550e8400-e29b-41d4-a716-446655440000"
                taskList:
                  summary: Tasks listed
                  value:
                    response: "Here are your tasks:\n1. Buy groceries\n2. Call mom\n3. Finish report"
                    tool_calls:
                      - tool: "list_tasks"
                        result: "success"
                        count: 3
                generalResponse:
                  summary: General response (no tools)
                  value:
                    response: "I can help you manage your tasks! Try saying 'Add task buy groceries' or 'Show my tasks'."
                    tool_calls: []
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Message cannot be empty"
        '401':
          description: Unauthorized - Invalid or missing JWT
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Not authenticated"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                detail: "Too many requests. Please wait before sending another message."
        '503':
          description: AI service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              example:
                response: "I'm having trouble connecting right now. Please try again in a moment."
                error: true

  /chat/history:
    get:
      tags:
        - Chat
      summary: Get conversation history
      description: |
        Retrieve the user's conversation history.
        Messages are returned in chronological order (oldest first).
      operationId: getChatHistory
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of messages to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: before
          in: query
          description: Return messages before this message ID (for pagination)
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation history retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatHistoryResponse'
              example:
                messages:
                  - id: "550e8400-e29b-41d4-a716-446655440001"
                    role: "user"
                    content: "Add a task to buy groceries"
                    created_at: "2026-01-22T10:30:00Z"
                  - id: "550e8400-e29b-41d4-a716-446655440002"
                    role: "tool"
                    content: '{"status": "success", "task_id": "...", "title": "buy groceries"}'
                    tool_name: "add_task"
                    created_at: "2026-01-22T10:30:01Z"
                  - id: "550e8400-e29b-41d4-a716-446655440003"
                    role: "assistant"
                    content: "I've added 'buy groceries' to your tasks."
                    created_at: "2026-01-22T10:30:02Z"
                has_more: false
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Chat
      summary: Clear conversation history
      description: |
        Delete all messages in the user's conversation.
        The conversation record is preserved but all messages are removed.
      operationId: clearChatHistory
      security:
        - BearerAuth: []
      responses:
        '204':
          description: History cleared successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/auth/signin

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          minLength: 1
          maxLength: 2000
          description: User's natural language message
          example: "Add a task to buy groceries"

    ChatResponse:
      type: object
      required:
        - response
      properties:
        response:
          type: string
          description: AI assistant's response message
          example: "I've added 'buy groceries' to your tasks."
        tool_calls:
          type: array
          description: List of tools that were called during this interaction
          items:
            $ref: '#/components/schemas/ToolCallResult'
          default: []
        error:
          type: boolean
          description: Whether this response indicates an error condition
          default: false

    ToolCallResult:
      type: object
      required:
        - tool
        - result
      properties:
        tool:
          type: string
          enum:
            - add_task
            - list_tasks
            - complete_task
            - delete_task
            - update_task
          description: Name of the tool that was called
        result:
          type: string
          enum:
            - success
            - error
          description: Outcome of the tool execution
        task_id:
          type: string
          format: uuid
          description: ID of the affected task (if applicable)
        count:
          type: integer
          description: Number of items (for list_tasks)
        error_message:
          type: string
          description: Error details (if result is error)

    ChatHistoryResponse:
      type: object
      required:
        - messages
        - has_more
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/MessageResponse'
        has_more:
          type: boolean
          description: Whether more messages exist before the returned set

    MessageResponse:
      type: object
      required:
        - id
        - role
        - content
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique message identifier
        role:
          type: string
          enum:
            - user
            - assistant
            - tool
          description: Message sender role
        content:
          type: string
          description: Message content
        tool_name:
          type: string
          description: Name of tool (only for role=tool)
        tool_call_id:
          type: string
          description: OpenAI tool call ID (only for role=tool)
        created_at:
          type: string
          format: date-time
          description: Message creation timestamp

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: "Not authenticated"
