# Implementation Plan: Todo AI Chatbot

**Branch**: `002-todo-ai-chatbot` | **Date**: 2026-01-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-todo-ai-chatbot/spec.md`

## Summary

Integrate an AI-powered chatbot into the Phase 2 Todo application that enables users to manage tasks through natural language conversation. The chatbot uses OpenAI Agents SDK with function tools to interpret user intent and execute task operations (add, list, complete, delete, update) via the existing task service layer. All conversation state is persisted to the database for stateless recovery.

## Technical Context

**Language/Version**: Python 3.11+ (Backend), TypeScript 5.x (Frontend)
**Primary Dependencies**: FastAPI, SQLModel, OpenAI Agents SDK (`openai-agents`), Next.js 14
**Storage**: Neon Serverless PostgreSQL (existing) + Conversation/Message tables
**Testing**: pytest (backend), Jest/React Testing Library (frontend), Playwright (E2E)
**Target Platform**: Web application (localhost development, Vercel/cloud deployment)
**Project Type**: Web (frontend + backend monorepo)
**Performance Goals**: Chat response < 5s (includes AI processing), History load < 2s
**Constraints**: Stateless backend, single conversation per user, JWT auth required
**Scale/Scope**: Same as Phase 2 (small-medium user base)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Pre-Design | Post-Design | Notes |
|-----------|------------|-------------|-------|
| I. Accuracy | âœ… | âœ… | All behavior matches spec user stories |
| II. Consistency | âœ… | âœ… | Chat API follows same patterns as task API |
| III. Security | âœ… | âœ… | JWT auth required, no new auth system |
| IV. User Isolation | âœ… | âœ… | Conversation FK to user, tools scoped to user_id |
| V. Reproducibility | âœ… | âœ… | Plan + contracts fully documented |
| VI. Simplicity | âœ… | âœ… | Function tools (not MCP), minimal new code |
| VII. AI Reliability | âœ… | âœ… | Structured tool responses, no hallucinated actions |
| VIII. Stateless Recovery | âœ… | âœ… | All state in database, no server memory |

**Gate Status**: PASSED

## Project Structure

### Documentation (this feature)

```text
specs/002-todo-ai-chatbot/
â”œâ”€â”€ plan.md                    # This file
â”œâ”€â”€ spec.md                    # Feature specification
â”œâ”€â”€ research.md                # Phase 0 research findings
â”œâ”€â”€ data-model.md              # Database schema design
â”œâ”€â”€ quickstart.md              # Implementation getting started
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ chat-api.yaml          # OpenAPI 3.1 specification
â”‚   â””â”€â”€ tool-specifications.md # AI tool interface contracts
â””â”€â”€ tasks.md                   # Implementation tasks (generated by /sp.tasks)
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                # MODIFY: Add chat router
â”‚   â”œâ”€â”€ database.py            # MODIFY: Import new models
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py        # MODIFY: Export new models
â”‚   â”‚   â”œâ”€â”€ conversation.py    # NEW: Conversation SQLModel
â”‚   â”‚   â””â”€â”€ message.py         # NEW: Message SQLModel
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py        # MODIFY: Export new schemas
â”‚   â”‚   â””â”€â”€ chat.py            # NEW: Chat request/response schemas
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ chat.py            # NEW: ChatService with AI agent
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ __init__.py        # MODIFY: Export chat router
â”‚       â””â”€â”€ chat.py            # NEW: Chat API endpoints
â””â”€â”€ requirements.txt           # MODIFY: Add openai-agents

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ layout.tsx         # MODIFY: Add ChatWidget
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ chat/              # NEW: All chat UI components
â”‚   â”‚       â”œâ”€â”€ ChatWidget.tsx
â”‚   â”‚       â”œâ”€â”€ ChatButton.tsx
â”‚   â”‚       â”œâ”€â”€ ChatWindow.tsx
â”‚   â”‚       â”œâ”€â”€ MessageList.tsx
â”‚   â”‚       â”œâ”€â”€ MessageItem.tsx
â”‚   â”‚       â”œâ”€â”€ ChatInput.tsx
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useChat.ts         # NEW: Chat state management
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ types.ts           # MODIFY: Add chat types
â””â”€â”€ package.json               # No new dependencies
```

**Structure Decision**: Web application structure (Option 2) - extends existing Phase 2 layout with new chat module in both backend and frontend.

## Architecture Overview

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Frontend (Next.js)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Existing UI    â”‚    â”‚           ChatWidget (New)                â”‚   â”‚
â”‚  â”‚  - Tasks page   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  - Dashboard    â”‚    â”‚  â”‚ChatButton  â”‚  â”‚  ChatWindow      â”‚    â”‚   â”‚
â”‚  â”‚  - Auth pages   â”‚    â”‚  â”‚ (floating) â”‚  â”‚  - MessageList   â”‚    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - ChatInput     â”‚    â”‚   â”‚
â”‚                         â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                â”‚
â”‚                                        â”‚ useChat hook                   â”‚
â”‚                                        â–¼                                â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                         â”‚        api.ts (existing)                  â”‚   â”‚
â”‚                         â”‚  POST /api/chat                          â”‚   â”‚
â”‚                         â”‚  GET  /api/chat/history                  â”‚   â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â”‚ HTTPS + JWT
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Backend (FastAPI)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Chat Router (New)                           â”‚   â”‚
â”‚  â”‚  POST /api/chat          - Send message, get AI response        â”‚   â”‚
â”‚  â”‚  GET  /api/chat/history  - Retrieve conversation                â”‚   â”‚
â”‚  â”‚  DELETE /api/chat/history - Clear conversation                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                â”‚
â”‚                                        â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     ChatService (New)                            â”‚   â”‚
â”‚  â”‚  - Load conversation history                                     â”‚   â”‚
â”‚  â”‚  - Create/configure AI Agent with tools                         â”‚   â”‚
â”‚  â”‚  - Run agent with user message                                  â”‚   â”‚
â”‚  â”‚  - Persist messages to database                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                            â”‚                                â”‚
â”‚           â”‚ Tools                      â”‚                                â”‚
â”‚           â–¼                            â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  Task Service   â”‚          â”‚  OpenAI API    â”‚                       â”‚
â”‚  â”‚  (existing)     â”‚          â”‚  (GPT-4)       â”‚                       â”‚
â”‚  â”‚  - create()     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚  â”‚  - list()       â”‚                                                    â”‚
â”‚  â”‚  - update()     â”‚                                                    â”‚
â”‚  â”‚  - delete()     â”‚                                                    â”‚
â”‚  â”‚  - complete()   â”‚                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PostgreSQL (Neon)                             â”‚   â”‚
â”‚  â”‚  Existing: user, task                                           â”‚   â”‚
â”‚  â”‚  New: conversation, message                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow: Chat Message

```
1. User types "Add task buy groceries" in ChatInput
2. useChat.sendMessage() called
3. Optimistic UI update (show user message)
4. POST /api/chat with JWT + message body
5. Backend extracts user_id from JWT
6. ChatService.process_message():
   a. Get/create conversation for user
   b. Load recent messages (context window)
   c. Create Agent with tools
   d. Run agent with message + history
   e. Agent calls add_task tool
   f. Tool calls TaskService.create()
   g. Task created in database
   h. Tool returns success result
   i. Agent generates response
   j. Save user message, tool call, assistant response to DB
7. Return ChatResponse with response + tool_calls
8. Frontend displays assistant message
9. Tasks page shows new task (via refresh/polling)
```

## Key Design Decisions

### 1. OpenAI Agents SDK with Function Tools (not MCP)

**Decision**: Use `@function_tool` decorator pattern instead of MCP protocol.

**Rationale**:
- Simpler implementation for single-application use case
- MCP designed for cross-application tool sharing (overkill here)
- Function tools have direct Python integration with automatic schema generation
- Easier debugging and testing

**Trade-offs**:
- Less portable if tools need to be shared externally
- Acceptable for this hackathon scope

### 2. Single Conversation Per User

**Decision**: One `Conversation` record per user (not multiple named conversations).

**Rationale**:
- Simpler UX (no conversation management UI needed)
- Matches spec assumption: "single conversation per user is sufficient"
- Reduces database complexity

**Trade-offs**:
- Users cannot have separate conversations for different contexts
- Can be extended later if needed (add conversation list UI)

### 3. Tools Call Task Service (not direct DB)

**Decision**: AI tools invoke the existing TaskService layer, not raw database queries.

**Rationale**:
- Single source of truth for business logic
- Automatic user isolation (TaskService already enforces ownership)
- Consistent validation rules across REST API and chat
- Easier to test (mock service layer)

### 4. Database-Backed Conversation State

**Decision**: All chat history in PostgreSQL, loaded per request.

**Rationale**:
- Constitution VIII requires stateless recovery
- Server restart preserves conversation
- Horizontal scaling ready
- Audit trail for tool executions

**Trade-offs**:
- Slightly higher latency per request (DB read)
- Acceptable for chat use case (not real-time streaming)

### 5. Floating Chat Widget (Bottom-Right)

**Decision**: Chat UI as floating button + slide-up panel.

**Rationale**:
- Industry standard placement (Intercom, Drift, etc.)
- Doesn't interfere with existing task UI
- Can be dismissed without navigation

## API Contracts

See `contracts/chat-api.yaml` for full OpenAPI specification.

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/api/chat` | POST | JWT | Send message, receive AI response |
| `/api/chat/history` | GET | JWT | Retrieve conversation history |
| `/api/chat/history` | DELETE | JWT | Clear conversation |

## Tool Contracts

See `contracts/tool-specifications.md` for detailed tool interfaces.

| Tool | Purpose | Parameters |
|------|---------|------------|
| `add_task` | Create task | title, description? |
| `list_tasks` | List tasks | filter? (all/pending/completed) |
| `complete_task` | Mark complete | task_identifier |
| `delete_task` | Remove task | task_identifier |
| `update_task` | Modify task | task_identifier, new_title?, new_description? |

## Error Handling

| Scenario | HTTP Status | Response |
|----------|-------------|----------|
| Missing JWT | 401 | `{"detail": "Not authenticated"}` |
| Invalid JWT | 401 | `{"detail": "Token expired"}` |
| Empty message | 400 | `{"detail": "Message cannot be empty"}` |
| AI service down | 503 | `{"response": "I'm having trouble...", "error": true}` |
| Tool execution fail | 200 | Tool error in response, agent explains |

## Dependencies

### New Python Packages

```
openai-agents>=0.1.0
```

### Environment Variables

```bash
# Add to backend/.env
OPENAI_API_KEY=sk-...
```

### No New Frontend Dependencies

Using existing: React 18, Next.js 14, fetch API

## Testing Strategy

### Backend Tests

| Layer | Test Type | Coverage |
|-------|-----------|----------|
| Models | Unit | Conversation/Message creation, relationships |
| Services | Unit | ChatService with mocked agent |
| Tools | Unit | Each tool with mocked TaskService |
| Routes | Integration | Full endpoint tests with mocked OpenAI |

### Frontend Tests

| Layer | Test Type | Coverage |
|-------|-----------|----------|
| Components | Unit | ChatButton, ChatWindow render/interaction |
| Hooks | Unit | useChat state management |
| Integration | E2E | Full chat flow with real backend |

### Manual Testing Checklist

- [ ] Send message, receive response
- [ ] Add task via chat, verify in task list
- [ ] Complete task via chat
- [ ] Delete task via chat
- [ ] Update task via chat
- [ ] List tasks via chat
- [ ] Refresh page, history persists
- [ ] Clear history, verify empty
- [ ] Logout, chat inaccessible
- [ ] Session expire, redirect to login

## Complexity Tracking

> **No violations requiring justification**

All design choices align with constitution principles. No additional complexity beyond minimum viable implementation.

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| OpenAI API latency (>5s) | Show typing indicator, implement timeout |
| Ambiguous user commands | Agent asks clarifying questions |
| Tool execution failures | Graceful error messages, no silent failures |
| Token costs | Monitor usage, consider rate limiting |

## Implementation Phases

### Phase 3.1: Database & Models
- Conversation and Message SQLModel classes
- Database migration

### Phase 3.2: Chat Service & Tools
- Tool functions with TaskService integration
- ChatService with Agent configuration
- Message persistence

### Phase 3.3: API Endpoints
- Chat router with all endpoints
- JWT authentication integration

### Phase 3.4: Frontend Components
- ChatWidget component hierarchy
- useChat hook
- Layout integration

### Phase 3.5: Integration & Polish
- End-to-end testing
- Error handling refinement
- UI polish

## Next Steps

1. Run `/sp.tasks` to generate detailed implementation tasks
2. Follow task order (respects dependencies)
3. Test each task before proceeding
4. Create PHR records during implementation

---

**Artifacts Generated**:
- `research.md` - Technology decisions and rationale
- `data-model.md` - Database schema design
- `contracts/chat-api.yaml` - OpenAPI specification
- `contracts/tool-specifications.md` - AI tool interfaces
- `quickstart.md` - Implementation guide

**ðŸ“‹ Architectural decision detected**: AI Framework Selection (OpenAI Agents SDK with Function Tools vs MCP)
Document reasoning and tradeoffs? Run `/sp.adr ai-framework-selection`
